trigger:
  branches: { include: [ main ] }
  paths:
    include: [ src/Backend/** ]


variables:
  pythonVersion: '3.12'

stages:
- stage: Backend
  displayName: Backend (Flask → Azure App Service)
  jobs:
  - job: build_and_deploy_backend
    pool: { vmImage: 'ubuntu-latest' }
    steps:
      - checkout: self

      - task: UsePythonVersion@0
        displayName: Use Python $(pythonVersion)
        inputs: { versionSpec: '$(pythonVersion)' }

      # >>> DŮLEŽITÉ: rozbalíme obsah src do KOŘENE balíčku
      - bash: |
          set -eux
          rm -rf out && mkdir -p out
          
          # Copy all files from backend directory
          if [ -d "src/Backend" ]; then
            cp -r src/Backend/* out/ 2>/dev/null || echo "No files in src/Backend to copy"
            # Also copy hidden files if any
            cp -r src/Backend/.[!.]* out/ 2>/dev/null || true
          fi
          
          # Copy requirements.txt to root of out
          cp requirements.txt out/requirements.txt

          # Create venv and install requirements *inside* the out folder
          cd out
          python3 -m venv .venv # Create a virtual environment named .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          deactivate
          cd ..
          
          echo "Contents of out directory:"
          ls -la out
          echo "All files:"
          find out -type f
        displayName: Stage backend package (flatten src to root)

      - task: ArchiveFiles@2
        displayName: Create deployment package
        inputs:
          rootFolderOrFile: 'out'
          includeRootFolder: false
          archiveType: 'zip'
          archiveFile: '$(Build.ArtifactStagingDirectory)/Backend.zip'

      # App Settings (Oryx build + port + import path + CORS)
      - task: AzureAppServiceSettings@1
        displayName: Configure App Settings
        inputs:
          azureSubscription: '$(AZURE_SUBSCRIPTION)'
          appName: '$(WEBAPP_NAME)'
          resourceGroupName: '$(WEBAPP_RG)'
          appSettings: |
            [
              { "name": "SCM_DO_BUILD_DURING_DEPLOYMENT", "value": "false", "slotSetting": false },
              { "name": "WEBSITE_RUN_FROM_PACKAGE", "value": "1", "slotSetting": false },
              { "name": "WEBSITES_PORT", "value": "5000", "slotSetting": false },
              { "name": "ENABLE_ORYX_BUILD", "value": "false", "slotSetting": false },
              { "name": "PYTHONPATH", "value": "/home/site/wwwroot", "slotSetting": false },
              { "name": "FRONTEND_ORIGIN", "value": "$(FRONTEND_ORIGIN)", "slotSetting": false }
            ]

      # Jednorázově (idempotentně) nastavíme startup (gunnicorn)
      - task: AzureCLI@2
        displayName: Set startup command (gunicorn with --chdir)
        inputs:
          azureSubscription: '$(AZURE_SUBSCRIPTION)'
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            az webapp config set \
              -g $(WEBAPP_RG) \
              -n $(WEBAPP_NAME) \
              --startup-file "/home/site/wwwroot/.venv/bin/python -m gunicorn --bind 0.0.0.0:5000 --timeout 600 --chdir /home/site/wwwroot app:app"

      - task: AzureWebApp@1
        displayName: Deploy to App Service (ZipDeploy)
        inputs:
          azureSubscription: '$(AZURE_SUBSCRIPTION)'
          appType: 'webAppLinux'
          appName: '$(WEBAPP_NAME)'
          package: '$(Build.ArtifactStagingDirectory)/Backend.zip'
