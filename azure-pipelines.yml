trigger:
  branches: { include: [ main ] }
  paths:
    include: [ src/Backend/** ]

variables:
  pythonVersion: '3.12'
  # (volitelné) defaulty pro obtížnost — můžeš kdykoli upravit v Azure App Settings
  CONNECTK_ROLLOUTS_EASY: '400'
  CONNECTK_ROLLOUTS_MEDIUM: '2000'
  CONNECTK_ROLLOUTS_HARD: '8000'

stages:
- stage: Backend
  displayName: Backend (Flask → Azure App Service)
  jobs:
  - job: build_and_deploy_backend
    pool: { vmImage: 'ubuntu-latest' }
    steps:
      # >>> důležité: stáhne i git submoduly
      - checkout: self
        submodules: true
        persistCredentials: true

      # RYCHLÁ KONTROLA: submodul přítomen v repu
      - bash: |
          set -eux
          git submodule status
          test -f src/Backend/third_party/omega_gomoku_ai/Omega_Gomoku_AI/Game/Board.py
          test -f src/Backend/third_party/omega_gomoku_ai/Omega_Gomoku_AI/Player/AI_MCTS.py
          echo "OK (repo): Board.py & AI_MCTS.py present in submodule"
        displayName: Verify submodule presence (in repo)

      - task: UsePythonVersion@0
        displayName: Use Python $(pythonVersion)
        inputs: { versionSpec: '$(pythonVersion)' }

      - bash: |
          set -eux
          rm -rf out && mkdir -p out
          
          # Copy all files from backend directory
          if [ -d "src/Backend" ]; then
            cp -r src/Backend/* out/ 2>/dev/null || echo "No files in src/Backend to copy"
            cp -r src/Backend/.[!.]* out/ 2>/dev/null || true
          fi
          
          # Copy requirements.txt to root of out
          cp requirements.txt out/requirements.txt
          
          echo "Contents of out directory (no venv):"
          ls -la out
          echo "Submodule files inside out (should exist):"
          ls -la out/third_party/omega_gomoku_ai/Omega_Gomoku_AI || true
          
          # RYCHLÁ KONTROLA: submodul v balíčku
          test -f out/third_party/omega_gomoku_ai/Omega_Gomoku_AI/Game/Board.py
          test -f out/third_party/omega_gomoku_ai/Omega_Gomoku_AI/Player/AI_MCTS.py
          echo "OK (package): Board.py & AI_MCTS.py present in out/"
        displayName: Stage backend package (files only)

      - task: ArchiveFiles@2
        displayName: Create deployment package
        inputs:
          rootFolderOrFile: 'out'
          includeRootFolder: false
          archiveType: 'zip'
          archiveFile: '$(Build.ArtifactStagingDirectory)/Backend.zip'

      # App Settings: Oryx Build
      - task: AzureAppServiceSettings@1
        displayName: Configure App Settings (Enable Oryx Build)
        inputs:
          azureSubscription: '$(AZURE_SUBSCRIPTION)'
          appName: '$(WEBAPP_NAME)'
          resourceGroupName: '$(WEBAPP_RG)'
          appSettings: |
            [
              { "name": "SCM_DO_BUILD_DURING_DEPLOYMENT", "value": "true", "slotSetting": false },
              { "name": "PYTHON_VERSION", "value": "$(pythonVersion)", "slotSetting": false },
              { "name": "WEBSITES_PORT", "value": "5000", "slotSetting": false },
              { "name": "FRONTEND_ORIGIN", "value": "$(FRONTEND_ORIGIN)", "slotSetting": false },
              { "name": "WEBSITE_RUN_FROM_PACKAGE", "value": "0", "slotSetting": false },
              { "name": "ENABLE_ORYX_BUILD", "value": "true", "slotSetting": false },
              { "name": "CONNECTK_ROLLOUTS_EASY", "value": "$(CONNECTK_ROLLOUTS_EASY)", "slotSetting": false },
              { "name": "CONNECTK_ROLLOUTS_MEDIUM", "value": "$(CONNECTK_ROLLOUTS_MEDIUM)", "slotSetting": false },
              { "name": "CONNECTK_ROLLOUTS_HARD", "value": "$(CONNECTK_ROLLOUTS_HARD)", "slotSetting": false }
            ]

      # Startup command
      - task: AzureCLI@2
        displayName: Set startup command (gunicorn)
        inputs:
          azureSubscription: '$(AZURE_SUBSCRIPTION)'
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            az webapp config set \
              -g $(WEBAPP_RG) \
              -n $(WEBAPP_NAME) \
              --startup-file "bash -lc \"tar -xzf /home/site/wwwroot/output.tar.gz -C /home/site/wwwroot && export PORT=\\\${PORT:-5000} && exec /home/site/wwwroot/antenv/bin/gunicorn --bind 0.0.0.0:\\\$PORT --chdir /home/site/wwwroot app:app\""

      - task: AzureWebApp@1
        displayName: Deploy to App Service (ZipDeploy)
        inputs:
          azureSubscription: '$(AZURE_SUBSCRIPTION)'
          appType: 'webAppLinux'
          appName: '$(WEBAPP_NAME)'
          package: '$(Build.ArtifactStagingDirectory)/Backend.zip'
