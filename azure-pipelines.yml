trigger:
  branches: { include: [ main ] }
  paths:
    include: [ src/** ]
    exclude: [ src/App/web/** ]  # nepusť BE při čistě FE změnách

variables:
  pythonVersion: '3.12'

stages:
- stage: Backend
  displayName: Backend (FastAPI → Azure App Service)
  jobs:
  - job: build_and_deploy_backend
    pool: { vmImage: 'ubuntu-latest' }
    steps:
      - checkout: self

      - task: UsePythonVersion@0
        inputs: { versionSpec: '$(pythonVersion)' }

      # >>> DŮLEŽITÉ: rozbalíme obsah src do KOŘENE balíčku
      - bash: |
          set -eux
          rm -rf out && mkdir -p out
          cp -R src/* out/
          cp src/requirements.txt out/requirements.txt
          ls -la out
        displayName: Stage backend package (flatten src to root)

      - task: ArchiveFiles@2
        inputs:
          rootFolderOrFile: 'out'
          includeRootFolder: false
          archiveType: 'zip'
          archiveFile: '$(Build.ArtifactStagingDirectory)/backend.zip'

      # App Settings (Oryx build + port + import path + CORS)
      - task: AzureAppServiceSettings@1
        displayName: Configure App Settings
        inputs:
          azureSubscription: '$(AZURE_SUBSCRIPTION)'
          appName: '$(WEBAPP_NAME)'
          resourceGroupName: '$(RESOURCE_GROUP_NAME)'
          appSettings: |
            [
              { "name": "SCM_DO_BUILD_DURING_DEPLOYMENT", "value": "true", "slotSetting": false },
              { "name": "WEBSITES_PORT", "value": "8000", "slotSetting": false },
              { "name": "PYTHONPATH", "value": "/home/site/wwwroot", "slotSetting": false },
              { "name": "FRONTEND_ORIGIN", "value": "$(FRONTEND_ORIGIN)", "slotSetting": false }
            ]

      # Jednorázově (idempotentně) nastavíme startup (uvicorn)
      - task: AzureCLI@2
        displayName: Set startup command (uvicorn)
        inputs:
          azureSubscription: '$(AZURE_SUBSCRIPTION)'
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            az webapp config set \
              -g $(WEBAPP_RG) \
              -n $(WEBAPP_NAME) \
              --startup-file "python -m uvicorn App.api.main:app --host 0.0.0.0 --port 8000 --app-dir /home/site/wwwroot"

      - task: AzureWebApp@1
        displayName: Deploy to App Service (ZipDeploy)
        inputs:
          azureSubscription: '$(AZURE_SUBSCRIPTION)'
          appType: 'webAppLinux'
          appName: '$(WEBAPP_NAME)'
          package: '$(Build.ArtifactStagingDirectory)/backend.zip'
